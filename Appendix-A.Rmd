```{=html}
<style type="text/css">
details:hover { cursor: pointer }
</style>
```
---
author: "Benjamin Meyer, Kenai Watershed Forum"
date: "`r Sys.Date()`"
output: html_document:
  code_folding: hide
---

# (APPENDIX) Appendix {.unnumbered}

# Appendix: Data Uplift to EPA WQX

## Introduction

Prior to analysis and interpretation of water quality data, we will ensure that all data that meets QA/QC standards outlined in the project Quality Assurance Project Plan (QAPP) [@kenaiwatershedforum2020] is accessible in the appropriate repository. Water quality data for this project is ultimately destined for the EPA Water Quality Exchange (EPA WQX), formerly EPA STORET.

Section B10 of the 2020 QAPP describes data management details and responsible parties for each step of the data pipeline from observation to repository.

### 2021 Water Quality Data

Water quality data generated from the Kenai River Baseline Water Quality Monitoring (KRBWQM) program was submitted to the Soldotna office of the Alaska Department of Environmental Conservation (ADEC) in January 2022 using the project-specific AQWMS Template provided by ADEC.



#### 2021 Water Quality Data AQWMS Formatting

The code script below assembles water quality data from the three analytic laboratories that partnered with Kenai Watershed Forum for this project in 2021:

-   SGS Laboratories (Anchorage, AK)

-   Soldotna Wastewater Treatment Plant (Soldotna, AK)

-   Taurianen Engineering (Soldotna, AK)


##### Spring 2021

Download Original Spring 2021 SGS Lab Results Files: (Click Link)

<details>

<summary>

Show Code used to Prepare 2021 (Spring & Summer) SGS Results for AQWMS Template

</summary>

```{r, 2021 AQWMS formatting, eval = F}


# clear environment
rm(list=ls())

# load packages
library(tidyverse)
library(readxl)
library(openxlsx)
library(data.table)
library(stringr)
library(magrittr)

# Spring 2021 sampling date
spring21_sample_date <- "5/11/2021"

# Summer 2021 Sampling Date
summer21_sample_date <-"8/27/2021"

##################### SGS data #####################

## Reformat SGS data downloaded from their server client (SGS Engage) to match AQWMS template

### spring 2021 SGS data

#### read in results downloaded from SGS 
spring_sgs21 <- read_excel("other/input/2021_wqx_data/spring_2021_wqx_data/SGS/Spring 2021 Results from SGS.xlsx", sheet = "Report", skip = 4) %>%
  mutate(`Lab Sample` = as.double(`Lab Sample`)) %>%
  # assign field sample date
  mutate(sample_date = spring21_sample_date) %>%
  clean_names()

### summer 2021 SGS data

#### read in results downloaded from SGS 
summer_sgs21 <- read_excel("other/input/2021_wqx_data/summer_2021_wqx_data/SGS/SGS_results_Summer2021.xlsx", sheet = "Report", skip = 4) %>%
  # filter out extraneous info
  filter(!`Client Sample` %in%c("Sample Comments","Client Sample Id"),
         !`Matrix` %in% "200.7 Total Ca, Fe, Mg were analyzed by ALS of Kelso, WA.",
         !is.na(`Lab Sample`)) %>%
  # remove blank columns
  select(-starts_with("...")) %>%
  # assign field sample date
  mutate(sample_date = summer21_sample_date) %>%
  clean_names()

# transform column types to prep for join
summer_sgs21 %<>%
  mutate(lab_sample = as.double(lab_sample),
         reporting_limit = as.double(reporting_limit))

# append spring and summer 2021 results
sgs21 <- bind_rows(spring_sgs21,summer_sgs21)
rm(spring_sgs21,summer_sgs21)


# upon visual inspection, we can see that the location names in the AQWMS template differ slightly from the place names in the SGS report (spelling and name inconsistencies).

#### address spelling/format issues and inconsistent sample/site names #####

  
# move info about duplicate sample and/or sample blank status into separate column
sgs21 %<>%
  mutate(sample_condition = case_when(
    grepl("Blank",client_sample) ~ "Blank",
    grepl("DUP",client_sample) ~ "DUP")) %>%
  # remove "DUP" designation from client_sample column
  mutate(client_sample = str_replace(client_sample, "DUP", "")) 

  
# remove from "client_sample" names the text containing the suffixes Diss/Dis (Dissolved metals sample) since we only want a list of unique sites. (Solution for this step found at https://stackoverflow.com/questions/29271549/replace-all-occurrences-of-a-string-in-a-data-frame)
sgs21 %<>%  
  mutate(client_sample = (str_replace(client_sample, "Diss|Dis|DUP", ""))) %>%

  # address the one stubborn site name still containing "Diss"
  mutate(client_sample = case_when(
    client_sample == "RM0-No Name Creek  Diss" ~ "RM0-No Name Creek",
    TRUE ~ client_sample)) %>%
  
  
# We need to remove white spaces, apostrophes, and dashes. Join functions such as "left_join" are often uncooperative with these types of strings
  
  # remove trailing white spaces
  mutate(client_sample = str_trim(client_sample,"right")) %>%
  
  # make remaining white spaces underscores
  mutate(client_sample = gsub("\\s+","_",client_sample)) %>%
  
  # replace dashes with underscores
  mutate(client_sample = gsub("\\-","_",client_sample)) %>%
  
  # replace multiple underscores with single
  mutate(client_sample = gsub("\\__","_",client_sample)) %>%
  
  # remove apostrophes
  mutate(client_sample = gsub("\\'","",client_sample))
  
  
# for summer samples, need to address "Trip blanks"; look @ field forms to figure out which ones went with which group ...(no name (KWF) vs others (USFWS))

# sent email to alexandra daniel w/ SGS on 2/4/2022 to inquire






# In preparation for a join to AQWMS table, we will manually generate a match table csv file that we can use 

## generate list of unique site names from 2021 SGS data
sgs21_sitenames <- data.table(unique(sgs21$client_sample)) 
  

# generate list of unique site names from 2021 AQWMS template
aqwms21_sitenames <- read_excel("other/input/AQWMS/AWQMS_KWF_Baseline_2021.xlsx", sheet = "Monitoring Locations") %>%
  select("Monitoring Location Name", "Monitoring Location ID") %>%
  distinct()

# write 2021 sgs site names to an excel file
site_match_table_path <- "other/input/AQWMS/site_names_matching_table.xlsx"
write.xlsx(sgs21_sitenames, site_match_table_path) 

# create an excel file with two sheets: a.) SGS site names, and b.) AQWMS site names
wb <- loadWorkbook(site_match_table_path)
addWorksheet(wb,"Sheet2")
writeData(wb,"Sheet2",aqwms21_sitenames)
saveWorkbook(wb,site_match_table_path,overwrite = TRUE)


# Using these two tables, we will manually create a new file titled "site_names_matching_table_manual_edit.xlsx" and manually match up the two disparate naming systems. Performed by B Meyer January 2022. 


# append "Monitoring Location Name" and "Monitoring Location ID" info from WQX to spring 2021 SGS data

## read in site names join table
sitenames21_match <- read_excel("other/input/AQWMS/site_names_matching_table_manual_edit.xlsx") %>%
  select(`Monitoring Location Name`,`Monitoring Location ID`,sgs_sitenames) %>%
  rename(client_sample = sgs_sitenames)

# append monitoring location names
sgs21 %<>%
  left_join(sitenames21_match, by = "client_sample") %>%
  clean_names()


## append monitoring location info (*)



# create column structure from example in AQWMS template. Use existing input from SGS results if applicable, specify value from "Permitted Values" tab if SGS input not applicable or not yet specified

z <- sgs21 %>%
  mutate(
    # `Monitoring Location ID` - already present, lowercase
    `Activity Media Name` = "Water",
    `Activity Media Subdivision Name` = "Surface Water",
    ####`Activity ID` = paste0(monitoring_location_id,"-",sample_date,"-",analyte),
    # append sample condition (e.g. DUP) if applicable
    `Activity ID` = ifelse(is.na(sample_condition),`Activity ID`, paste0(`Activity ID`,"-",sample_condition)),
    `Activity Latitude` = "*",
    `Activity Longitude` = "*",
    `Activity Source Map Scale` = "*",
    `Activity Type` = case_when(
      sample_condition == "DUP" ~ "Quality Control Field Replicate Msr/Obs",
      TRUE ~ "Field Msr/Obs"),
    `Characteristic Name` = analyte)
    

    
    
    

# check out example from other WQP downoad
z1 <- read.csv("other/input/wqp_data/narrowresult.csv")

z1$Act







### 1st step:::: make sure that monitoring list locations matches those currently match those in DEC AQWMS database (AWQMS public login: https://awqms2.goldsystems.com/Login.aspx, username akpublic, no password)






```
</details>

<br>

```{r}
# Taurianen data
## Reformat Taurianen data to match AQWMS template

```

```{r}
# Soldotna Wastewater Treatment Plant
## Reformat SWWTP data to match AQWMS template


```





```{r, notes, include = F}

# course of action

# uplift 2021 data

# audit existing data in WQX

# confirm with DEC that they are addressing data 2017 - 2020

# attempt to download missing data from  AQWMS, then upload to EPA WQX

# if not available, reshape data from shared drive to uplift to EPA WQX (big task)

```

<br>

## 2021 Baseline Water Quality Data

```{r, other notes, include = F}

# ultimately, would like to set up auto query of EPA WQX so this report updates automatically (github actions or other methods...?); eg see front matter guts of https://geocompr.robinlovelace.net/.

```
